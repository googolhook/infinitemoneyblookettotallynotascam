<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;
const scoreDisplay = document.getElementById("score");
const startScreen = document.getElementById("startScreen");
const startBtn = document.getElementById("startBtn");
const difficultySelect = document.getElementById("difficulty");
const loginScreen = document.getElementById("loginScreen");
const signupScreen = document.getElementById("signupScreen");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const toSignupBtn = document.getElementById("toSignupBtn");
const backToLoginBtn = document.getElementById("backToLoginBtn");
const playerInfo = document.getElementById("playerInfo");
const logoutBtn = document.getElementById("logoutBtn");
const scoreTable = document.getElementById("scoreTable");
const debugPanel = document.getElementById("debugPanel");
const userSelect = document.getElementById("userSelect");
const pointsRange = document.getElementById("pointsRange");
const pointsValue = document.getElementById("pointsValue");
const givePointsBtn = document.getElementById("givePointsBtn");
const removePointsBtn = document.getElementById("removePointsBtn");
const debugToggle = document.getElementById("debugToggle");
const debugContent = document.getElementById("debugContent");

let score = 0;
let snake, food, d, game, speed;
let currentUser = null;

// Load users globally
function loadUsers() {
  return JSON.parse(localStorage.getItem("snakeUsers")) || {};
}
function saveUsers(users) {
  localStorage.setItem("snakeUsers", JSON.stringify(users));
}

// Keep logged-in user
function saveCurrentUser(user) {
  localStorage.setItem("snakeCurrentUser", user);
}
function loadCurrentUser() {
  return localStorage.getItem("snakeCurrentUser");
}

// Update scoreboard globally
function updateScoreboard() {
  const users = loadUsers();
  const sorted = Object.entries(users).sort((a,b)=>b[1].highScore - a[1].highScore);
  scoreTable.innerHTML = "<tr><th>Player</th><th>High Score</th></tr>";
  sorted.forEach(([name, data])=>{
    scoreTable.innerHTML += `<tr><td>${name}</td><td>${data.highScore}</td></tr>`;
  });
}

// Populate debug user dropdown
function updateUserDropdown() {
  const users = loadUsers();
  userSelect.innerHTML = "";
  for (const user in users) {
    const opt = document.createElement("option");
    opt.value = user;
    opt.textContent = user;
    userSelect.appendChild(opt);
  }
}

// Navigation
toSignupBtn.addEventListener("click", ()=>{
  loginScreen.style.display = "none";
  signupScreen.style.display = "block";
});
backToLoginBtn.addEventListener("click", ()=>{
  signupScreen.style.display = "none";
  loginScreen.style.display = "block";
});

// Login
loginBtn.addEventListener("click", ()=>{
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  if(!username || !password) return alert("Enter username and password!");

  let users = loadUsers();
  if(!users[username]) return alert("User does not exist! Please sign up first.");
  if(users[username].password !== password) return alert("Incorrect password!");

  currentUser = username;
  saveCurrentUser(username);
  loginScreen.style.display = "none";
  startScreen.style.display = "block";
  playerInfo.textContent = `üë§ Logged in as: ${username} | High Score: ${users[username].highScore}`;
  updateScoreboard();
  updateUserDropdown();
  debugPanel.style.display = (username === "debug") ? "block" : "none";
});

// Signup
signupBtn.addEventListener("click", ()=>{
  const username = document.getElementById("signupUsername").value.trim();
  const password = document.getElementById("signupPassword").value.trim();
  if(!username || !password) return alert("Enter username and password!");

  let users = loadUsers();
  if(users[username]) return alert("Username already exists!");
  users[username] = { password, highScore: 0, email: "" };
  saveUsers(users);

  alert("‚úÖ Account created! You can now log in.");
  signupScreen.style.display = "none";
  loginScreen.style.display = "block";
});

// Logout
logoutBtn.addEventListener("click", ()=>{
  currentUser = null;
  localStorage.removeItem("snakeCurrentUser");
  startScreen.style.display = "none";
  loginScreen.style.display = "block";
  debugContent.style.display = "none";
  debugToggle.innerText = "üß© Debug Panel ‚ñº";
});

// Auto-login if user saved
window.addEventListener("load", () => {
  const user = loadCurrentUser();
  if(user && loadUsers()[user]) {
    currentUser = user;
    loginScreen.style.display = "none";
    startScreen.style.display = "block";
    const users = loadUsers();
    playerInfo.textContent = `üë§ Logged in as: ${user} | High Score: ${users[user].highScore}`;
    updateScoreboard();
    updateUserDropdown();
    debugPanel.style.display = (user === "debug") ? "block" : "none";
  }
});

// Password reset via email simulation
function sendPasswordReset(email) {
  alert(`üìß Password reset link sent to ${email} (simulation)`);
}

document.getElementById("loginScreen").insertAdjacentHTML("beforeend",
  `<br><button id="resetPasswordBtn">Forgot Password?</button>`
);

document.getElementById("resetPasswordBtn").addEventListener("click", ()=>{
  const username = prompt("Enter your username for password reset:");
  if(!username) return;
  const users = loadUsers();
  if(!users[username] || !users[username].email) return alert("User/email not found.");
  sendPasswordReset(users[username].email);
});

// Debug panel: give/remove points
pointsRange.addEventListener("input", ()=> {
  pointsValue.textContent = pointsRange.value;
});

debugToggle.addEventListener("click", ()=>{
  if (debugContent.style.display === "none" || debugContent.style.display === "") {
    debugContent.style.display = "block";
    debugToggle.innerText = "üß© Debug Panel ‚ñ≤";
  } else {
    debugContent.style.display = "none";
    debugToggle.innerText = "üß© Debug Panel ‚ñº";
  }
});

givePointsBtn.addEventListener("click", ()=>{
  if (currentUser !== "debug") return;
  const users = loadUsers();
  const selected = userSelect.value;
  const points = parseInt(pointsRange.value);
  users[selected].highScore += points;
  saveUsers(users);
  updateScoreboard();
  alert(`‚úÖ Gave ${points} points to ${selected}`);
});

removePointsBtn.addEventListener("click", ()=>{
  if (currentUser !== "debug") return;
  const users = loadUsers();
  const selected = userSelect.value;
  const points = parseInt(pointsRange.value);
  users[selected].highScore = Math.max(0, users[selected].highScore - points);
  saveUsers(users);
  updateScoreboard();
  alert(`‚ö†Ô∏è Removed ${points} points from ${selected}`);
});

// Debug: change password
debugContent.insertAdjacentHTML("beforeend",
  `<br><button id="changePasswordBtn">Change Password</button>`
);

document.getElementById("changePasswordBtn").addEventListener("click", ()=>{
  if(currentUser !== "debug") return;
  const users = loadUsers();
  const selected = userSelect.value;
  const newPass = prompt(`Enter new password for ${selected}:`);
  if(!newPass) return;
  users[selected].password = newPass;
  saveUsers(users);
  alert(`üîë Password for ${selected} updated.`);
});

// --- Snake game functions ---
startBtn.addEventListener("click", startGame);

function startGame() {
  if(!currentUser) return alert("Please login first!");
  speed = parseInt(difficultySelect.value);
  startScreen.style.display = "none";
  canvas.style.display = "block";
  scoreDisplay.style.display = "block";
  resetGame();
  game = setInterval(draw, speed);
}

function resetGame() {
  score = 0;
  scoreDisplay.textContent = "Score: 0";
  snake = [{ x: 9 * box, y: 10 * box }];
  food = {
    x: Math.floor(Math.random() * 19 + 1) * box,
    y: Math.floor(Math.random() * 19 + 1) * box,
  };
  d = null;
}

document.addEventListener("keydown", direction);

function direction(event) {
  if (event.key === "ArrowLeft" && d !== "RIGHT") d = "LEFT";
  else if (event.key === "ArrowUp" && d !== "DOWN") d = "UP";
  else if (event.key === "ArrowRight" && d !== "LEFT") d = "RIGHT";
  else if (event.key === "ArrowDown" && d !== "UP") d = "DOWN";
}

function collision(head, array) {
  return array.some(part => head.x === part.x && head.y === part.y);
}

function draw() {
  ctx.fillStyle = "#111";
  ctx.fillRect(0, 0, 400, 400);

  snake.forEach((part, i) => {
    ctx.fillStyle = i === 0 ? "#0f0" : "#0a0";
    ctx.fillRect(part.x, part.y, box, box);
  });

  ctx.fillStyle = "#f00";
  ctx.fillRect(food.x, food.y, box, box);

  let snakeX = snake[0].x;
  let snakeY = snake[0].y;

  if (d === "LEFT") snakeX -= box;
  if (d === "UP") snakeY -= box;
  if (d === "RIGHT") snakeX += box;
  if (d === "DOWN") snakeY += box;

  if (snakeX === food.x && snakeY === food.y) {
    score++;
    scoreDisplay.textContent = "Score: " + score;
    food = {
      x: Math.floor(Math.random() * 19 + 1) * box,
      y: Math.floor(Math.random() * 19 + 1) * box,
    };
  } else {
    snake.pop();
  }

  const newHead = { x: snakeX, y: snakeY };

  if (snakeX < 0 || snakeY < 0 || snakeX >= 400 || snakeY >= 400 || collision(newHead, snake)) {
    clearInterval(game);
    endGame();
  }

  snake.unshift(newHead);
}

function endGame() {
  alert("üíÄ Game Over! Your score: " + score);
  const users = loadUsers();
  if (score > users[currentUser].highScore) {
    users[currentUser].highScore = score;
    alert("üéâ New High Score!");
    saveUsers(users);
  }
  updateScoreboard();
  canvas.style.display = "none";
  scoreDisplay.style.display = "none";
  startScreen.style.display = "block";
  playerInfo.textContent = `üë§ Logged in as: ${currentUser} | High Score: ${users[currentUser].highScore}`;
}
</script>
